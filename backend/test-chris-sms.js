const mongoose = require('mongoose');
const SMSService = require('./smsService');
require('dotenv').config();

async function testChrisSMS() {
  try {
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/medimate');
    console.log('‚úÖ Connected to MongoDB');
    
    const User = require('./models/User');
    const MedicationForm = require('./models/MedicationForm');
    
    // Get Chris Evans and his medications
    const chrisUser = await User.findOne({ email: 'chris@gmail.com' });
    const medications = await MedicationForm.find({ userId: chrisUser._id.toString() });
    
    console.log(`üë§ Testing SMS for: ${chrisUser.firstName} ${chrisUser.lastName}`);
    console.log(`üì± Phone: ${chrisUser.phone}`);
    console.log(`üíä Medications: ${medications.length}`);
    
    if (medications.length > 0) {
      const med = medications[0]; // Test with first medication
      console.log(`\nüîî Sending test SMS for: ${med.medicationName}`);
      
      // Format phone number properly
      let phoneNumber = chrisUser.phone;
      if (!phoneNumber.startsWith('+')) {
        phoneNumber = '+91' + phoneNumber; // Add India country code
      }
      
      console.log(`üì± Formatted phone: ${phoneNumber}`);
      
      // Send test SMS
      const result = await SMSService.sendMedicationReminder(
        phoneNumber,
        chrisUser.firstName,
        med.medicationName,
        'Now (Test)',
        '1 tablet',
        'Take with food',
        med._id
      );
      
      console.log('\nüì® SMS Result:', result);
      
      if (result.success) {
        console.log('‚úÖ SMS sent successfully!');
        console.log('üì± Check your phone for the reminder');
      } else if (result.code === 'UNVERIFIED_PHONE') {
        console.log('‚ùå ISSUE: Phone number needs to be verified in Twilio');
        console.log('üîß SOLUTION OPTIONS:');
        console.log('   1. Verify the phone number at: https://console.twilio.com/us1/develop/phone-numbers/manage/verified');
        console.log('   2. Or upgrade Twilio account to send to unverified numbers');
        console.log('   3. Or use a different verified phone number for testing');
      } else {
        console.log('‚ùå SMS failed:', result.error);
      }
    }
    
    mongoose.connection.close();
  } catch (error) {
    console.error('‚ùå Error:', error.message);
  }
}

testChrisSMS();