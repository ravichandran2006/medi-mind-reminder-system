// Medical Analysis System Test
// Tests the complete flow of uploading and analyzing medical documents

const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');

const API_BASE_URL = 'http://localhost:5001/api';

// Test user credentials (use existing test user or create one)
const TEST_USER = {
  email: 'test@medimate.com',
  password: 'test123456'
};

class MedicalAnalysisTest {
  constructor() {
    this.authToken = null;
  }

  async login() {
    try {
      console.log('üîê Logging in test user...');
      const response = await axios.post(`${API_BASE_URL}/auth/login`, TEST_USER);
      
      if (response.data.errNo === 0) {
        this.authToken = response.data.token;
        console.log('‚úÖ Login successful');
        return true;
      } else {
        console.error('‚ùå Login failed:', response.data.errMsg);
        return false;
      }
    } catch (error) {
      console.error('‚ùå Login error:', error.response?.data || error.message);
      return false;
    }
  }

  async testHealthCheck() {
    try {
      console.log('üè• Testing health check endpoint...');
      const response = await axios.get(`${API_BASE_URL}/health`);
      
      console.log('‚úÖ Health check response:', response.data);
      return response.data.status === 'OK';
    } catch (error) {
      console.error('‚ùå Health check failed:', error.message);
      return false;
    }
  }

  async createTestFile() {
    const testContent = `
MEDICAL PRESCRIPTION

===========================================
PATIENT INFORMATION:
===========================================
Patient Name: John Michael Doe
Age: 45 years old
Gender: Male
Weight: 75 kg
Phone: +1-555-0123
Date of Birth: 15/03/1979

===========================================
DOCTOR INFORMATION:
===========================================
Prescribing Physician: Dr. Sarah Johnson, MD
License No: MD12345
Clinic: City Medical Center
Date: ${new Date().toLocaleDateString('en-GB')}

===========================================
DIAGNOSIS:
===========================================
1. Type 2 Diabetes Mellitus (E11.9)
2. Essential Hypertension (I10)
3. Hyperlipidemia (E78.5)
4. Obesity (BMI 28.5)

===========================================
LABORATORY RESULTS:
===========================================
‚Ä¢ Fasting Blood Glucose: 165 mg/dL (HIGH) [Normal: 70-100 mg/dL]
‚Ä¢ HbA1c: 8.2% (HIGH) [Normal: <5.7%]
‚Ä¢ Total Cholesterol: 245 mg/dL (HIGH) [Normal: <200 mg/dL]
‚Ä¢ LDL Cholesterol: 155 mg/dL (HIGH) [Normal: <100 mg/dL]
‚Ä¢ HDL Cholesterol: 32 mg/dL (LOW) [Normal: >40 mg/dL for men]
‚Ä¢ Triglycerides: 280 mg/dL (HIGH) [Normal: <150 mg/dL]
‚Ä¢ Blood Pressure: 150/95 mmHg (HIGH) [Normal: <120/80 mmHg]
‚Ä¢ Creatinine: 1.2 mg/dL (NORMAL) [Normal: 0.74-1.35 mg/dL for men]

===========================================
CURRENT MEDICATIONS PRESCRIBED:
===========================================

1. METFORMIN (Glucophage)
   ‚Ä¢ Dosage: 500mg
   ‚Ä¢ Frequency: Twice daily (morning and evening)
   ‚Ä¢ Duration: Continue indefinitely
   ‚Ä¢ Instructions: Take with meals to reduce stomach upset
   ‚Ä¢ Purpose: Blood sugar control

2. LISINOPRIL (Prinivil)
   ‚Ä¢ Dosage: 10mg
   ‚Ä¢ Frequency: Once daily in the morning
   ‚Ä¢ Duration: Continue indefinitely
   ‚Ä¢ Instructions: Take at the same time each day
   ‚Ä¢ Purpose: Blood pressure control

3. ATORVASTATIN (Lipitor)
   ‚Ä¢ Dosage: 20mg
   ‚Ä¢ Frequency: Once daily at bedtime
   ‚Ä¢ Duration: Continue indefinitely
   ‚Ä¢ Instructions: Avoid grapefruit juice
   ‚Ä¢ Purpose: Cholesterol management

4. ASPIRIN (Low-dose)
   ‚Ä¢ Dosage: 81mg
   ‚Ä¢ Frequency: Once daily with breakfast
   ‚Ä¢ Duration: Continue indefinitely
   ‚Ä¢ Instructions: Take with food to prevent stomach irritation
   ‚Ä¢ Purpose: Cardiovascular protection

===========================================
DOSAGE RECOMMENDATIONS & ADJUSTMENTS:
===========================================

CURRENT ASSESSMENT:
‚Ä¢ Metformin 500mg BID is appropriate for current glucose levels
‚Ä¢ Lisinopril may need increase to 15mg if BP remains elevated
‚Ä¢ Atorvastatin dose adequate; monitor liver function
‚Ä¢ Aspirin dose appropriate for cardiovascular protection

RECOMMENDED MONITORING:
‚Ä¢ Blood glucose: Daily self-monitoring
‚Ä¢ Blood pressure: Weekly home monitoring
‚Ä¢ HbA1c: Every 3 months
‚Ä¢ Lipid panel: Every 6 months
‚Ä¢ Liver function tests: Every 6 months
‚Ä¢ Kidney function: Every 6 months

===========================================
LIFESTYLE RECOMMENDATIONS:
===========================================

DIET:
‚Ä¢ Reduce carbohydrate intake to <45% of total calories
‚Ä¢ Limit saturated fat to <7% of total calories
‚Ä¢ Increase fiber intake to 25-30g daily
‚Ä¢ Sodium restriction to <2300mg daily
‚Ä¢ Monitor portion sizes

EXERCISE:
‚Ä¢ Moderate physical activity 150 minutes per week
‚Ä¢ Include both aerobic and resistance training
‚Ä¢ Start slowly and gradually increase intensity
‚Ä¢ Check blood sugar before and after exercise

MONITORING:
‚Ä¢ Daily weight measurement
‚Ä¢ Blood pressure monitoring 3x weekly
‚Ä¢ Blood glucose monitoring as directed
‚Ä¢ Regular medication adherence

===========================================
FOLLOW-UP INSTRUCTIONS:
===========================================
‚Ä¢ Return visit in 4 weeks to assess medication effectiveness
‚Ä¢ Lab work (HbA1c, lipids, liver function) in 3 months
‚Ä¢ Annual eye exam and foot exam
‚Ä¢ Immediate medical attention if blood sugar >400 mg/dL

===========================================
PHARMACY INFORMATION:
===========================================
Pharmacy: City Pharmacy
Refills: 3 refills authorized for all medications
Pharmacist consultation recommended for new medications

Next Appointment: ${new Date(Date.now() + 28 * 24 * 60 * 60 * 1000).toLocaleDateString('en-GB')}

Dr. Sarah Johnson, MD
Internal Medicine
License: MD12345
Signature: [Digital Signature Applied]
    `.trim();

    const testFilePath = path.join(__dirname, 'test_medical_report.txt');
    await fs.promises.writeFile(testFilePath, testContent);
    return testFilePath;
  }

  async testMedicalAnalysis() {
    try {
      console.log('üìÑ Creating test medical document...');
      const testFilePath = await this.createTestFile();

      console.log('üì§ Uploading medical document for analysis...');
      const formData = new FormData();
      formData.append('medicalDocument', fs.createReadStream(testFilePath));

      const response = await axios.post(
        `${API_BASE_URL}/medical-analysis/upload`,
        formData,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`,
            ...formData.getHeaders()
          }
        }
      );

      if (response.data.success) {
        console.log('‚úÖ Medical analysis completed successfully');
        console.log('üìä Analysis Summary:');
        
        const analysis = response.data.data.analysis;
        
        // Display key results
        if (analysis.patient_details) {
          console.log('üë§ Patient Details:', analysis.patient_details);
        }
        
        if (analysis.conditions_found) {
          console.log('üè• Conditions Found:', analysis.conditions_found);
        }
        
        if (analysis.medications) {
          console.log('üíä Medications:', analysis.medications.length);
        }
        
        if (analysis.lab_values) {
          console.log('üî¨ Lab Values:', analysis.lab_values.length);
        }
        
        console.log('üìã Verification Status:', analysis.prescription_verification_summary);
        
        if (analysis.recommendations?.red_flags) {
          console.log('üö® Red Flags:', analysis.recommendations.red_flags);
        }

        // Cleanup test file
        await fs.promises.unlink(testFilePath);
        
        return {
          success: true,
          analysisId: response.data.data.analysisId,
          analysis: analysis
        };
      } else {
        console.error('‚ùå Medical analysis failed:', response.data.message);
        return { success: false };
      }
    } catch (error) {
      console.error('‚ùå Medical analysis test error:', error.response?.data || error.message);
      return { success: false };
    }
  }

  async testAnalysisHistory() {
    try {
      console.log('üìö Testing analysis history retrieval...');
      const response = await axios.get(
        `${API_BASE_URL}/medical-analysis/history`,
        {
          headers: {
            'Authorization': `Bearer ${this.authToken}`
          }
        }
      );

      if (response.data.success) {
        console.log('‚úÖ Analysis history retrieved successfully');
        console.log(`üìä Found ${response.data.data.length} analysis records`);
        return true;
      } else {
        console.error('‚ùå Failed to retrieve analysis history');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Analysis history test error:', error.response?.data || error.message);
      return false;
    }
  }

  async runAllTests() {
    console.log('üß™ Starting Medical Analysis System Tests...\n');

    // Test 1: Health Check
    const healthCheck = await this.testHealthCheck();
    if (!healthCheck) {
      console.error('‚ùå Health check failed. Make sure backend is running.');
      return;
    }

    // Test 2: Authentication
    const loginSuccess = await this.login();
    if (!loginSuccess) {
      console.error('‚ùå Authentication failed. Check test user credentials.');
      return;
    }

    // Test 3: Medical Analysis
    const analysisResult = await this.testMedicalAnalysis();
    if (!analysisResult.success) {
      console.error('‚ùå Medical analysis test failed.');
      return;
    }

    // Test 4: Analysis History
    const historySuccess = await this.testAnalysisHistory();
    if (!historySuccess) {
      console.error('‚ùå Analysis history test failed.');
      return;
    }

    console.log('\nüéâ All medical analysis tests completed successfully!');
    console.log('\nüìä Test Summary:');
    console.log('‚úÖ Health Check: Passed');
    console.log('‚úÖ Authentication: Passed');
    console.log('‚úÖ Medical Analysis: Passed');
    console.log('‚úÖ Analysis History: Passed');
    
    console.log('\nüåü Medical Analysis System is fully functional!');
    console.log('\nüöÄ Features Available:');
    console.log('   üì§ File Upload (PDF, Images)');
    console.log('   ü§ñ AI-Powered Analysis with Groq');
    console.log('   üî¨ Lab Value Verification');
    console.log('   üíä Medication Verification');
    console.log('   ‚ö†Ô∏è  Drug Interaction Checking');
    console.log('   üìã Risk Assessment');
    console.log('   üí° Lifestyle Recommendations');
    console.log('   üìö Analysis History');
    console.log('   üéØ Prescription Verification');
  }
}

// Run tests
const tester = new MedicalAnalysisTest();
tester.runAllTests().catch(console.error);